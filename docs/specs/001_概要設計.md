# 概要設計

## アプリの目的
ユーザーが筋力トレーニング中のフォームを客観的に記録・確認できるよう、
自身のカメラ映像と姿勢情報を同時に保存・再生できるアプリを開発する。

## 想定ユーザー
- 自宅やジムでフォーム改善を目指す個人
- トレーニングの再現性や動作の振り返りをしたい人

## 用語定義（プログラム上の明確化）
- Video：ユーザー自身を撮影した映像（録画データ）
- Movie：先生（手本）による事前収録の模範映像

## 主な機能（MVP）
- ホーム画面: 撮影開始、セッション履歴の表示
- 撮影画面: 手本Movieの再生と同期した自動画録、姿勢検出結果のリアルタイム表示
- 確認画面: 撮影済みのVideo再生、検出データの重ね合わせ

## 設計方針
- 1セッション＝1回のトレーニング記録（Video + 姿勢JSON）
- データベースは使用せず、ローカルの一時保存方式を採用
- 手本Movie再生開始でユーザー側の録画を自動開始し、終了通知で停止する
- 保存したVideoとPoseデータは後続の再生画面で同期再生できる構造とする

## 画面一覧

1. **起動画面（Splash）**
   - アプリ起動時に表示
   - ロゴ表示や初期化処理の待機

2. **ホーム画面(トレーニングメニュー一覧)**
   - 利用可能なトレーニングメニューの一覧
     - 画像 + メニュー名

3. **トレーニングメニュー詳細**
   - セッション一覧（履歴）の表示
   - 「お手本再生(仮)」ボタン
   - 「撮影開始」ボタン

4. **撮影画面**
   - カメラプレビュー
   - 手本Movie再生の開始ボタン
   - Movie再生中の自動画録（開始／停止ボタンは将来の手動操作用）
   - 姿勢検出データ（骨格ラインなど）のリアルタイムオーバーレイ
   - 再生時のオーバーレイ表示ON/OFF切替

5. **セッション詳細画面**
   - 各セッションをタップしたときに開く画面
   - 保存されたVideo再生コンポーネント
   - 同時に重ね合わせた姿勢検出結果の再生
     - 再生時のオーバーレイ表示ON/OFF切替

6. **設定画面**
   * 一時保存データのクリア

## 録画・保存フロー
1. ユーザーが手本Movieの再生を開始すると、同時に `RecordingSessionManager` がセッションIDを生成し録画用のディレクトリを作成する。
2. カメラから取得した `CMSampleBuffer` はリアルタイムに `AVAssetWriter` へ渡され、`video.mp4` として保存される。
3. 姿勢検出結果（`Pose`）は `PoseSerialization` で JSON Lines（NDJSON）形式に変換され、`pose.ndjson` として追記される。
4. Movie再生終了通知、または画面離脱イベントで録画を停止し、`session.json` にメタデータ（端末情報・カメラ設定・動画サイズ/FPS 等）を出力する。
5. 保存完了時にはアプリのログに保存先パスが出力され、`Documents/Sessions/<sessionId>/` が確認できる。

## 保存データ構成
- ディレクトリ: `Documents/Sessions/<sessionId>/`
  - `video.mp4`: H.264 で保存されたユーザー動画
  - `pose.ndjson`: 各フレームの `t_ms`、`img_size`、`score`、`joints` を持つ NDJSON
  - `session.json`: スキーマバージョン、端末情報、カメラ設定、動画ファイル情報、Poseファイル情報
- `pose.ndjson` の `joints` は COCO17 キーを採用し、値は [0,1] の正規化座標と信頼度 `c` を格納する。
- `session.json` の例:
  ```json
  {
    "schemaVersion": 1,
    "sessionId": "20251020-194929-7298",
    "createdAt": "2025-10-20T10:49:29Z",
    "device": { "model": "iPhone", "os": "iOS 18.1" },
    "camera": { "position": "back", "preset": "vga640x480" },
    "video": { "file": "video.mp4", "codec": "h264", "size": [640,480], "fps": 30.0 },
    "pose": { "file": "pose.ndjson", "jointSet": "coco17", "coords": "normalized" }
  }
  ```

